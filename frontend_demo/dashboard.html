<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Přehled - HeroWizzard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="navbar">
        <div class="container">
            <h1 id="app-title">HeroWizzard</h1>
            <nav>
                <a href="dashboard.html">Přehled</a>
                <a href="upload.html">Import CSV</a>
                <a href="categories.html">Pravidla kategorií</a>
                <a href="help.html">Nápověda</a>
            </nav>
            <div class="user-info">
                <span id="user-info">Načítání...</span>
                <button class="logout-btn" id="logout-btn">Odhlásit</button>
            </div>
        </div>
    </header>

    <main class="container">
        <div id="alert-container"></div>

        <!-- Stats -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Celkem transakcí</div>
                <div class="stat-value" id="stat-total">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Celkové příjmy</div>
                <div class="stat-value income" id="stat-income">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Celkové výdaje</div>
                <div class="stat-value expense" id="stat-expense">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Nezařazené</div>
                <div class="stat-value" id="stat-uncategorized">-</div>
            </div>
        </div>

        <!-- Transactions Card -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Transakce</h2>
                <div style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
                    <!-- Admin-only buttons (hidden by default, shown via JS) -->
                    <div id="admin-actions" style="display:none;gap:0.5rem;margin-right:0.5rem;padding-right:0.75rem;border-right:2px solid var(--gray-300);">
                        <button class="btn btn-sm" id="admin-import-btn" title="Importovat transakce ze zálohy JSON" style="background:#7c3aed;color:white;border:none;">Import zálohy</button>
                        <button class="btn btn-sm" id="admin-export-btn" title="Exportovat VŠECHNY transakce do zálohy JSON" style="background:#7c3aed;color:white;border:none;">Export zálohy</button>
                        <button class="btn btn-sm" id="admin-wipe-btn" title="Soft-delete všech transakcí" style="background:#991b1b;color:white;border:none;">Smazat vše</button>
                        <input type="file" id="admin-import-file" accept=".json" hidden>
                    </div>
                    <button class="btn btn-primary btn-sm" id="add-txn-btn">+ Přidat transakci</button>
                    <button class="btn btn-success btn-sm" id="export-btn" title="Exportovat filtrované transakce do Excelu">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export Excel
                    </button>
                    <button class="btn btn-outline btn-sm" id="refresh-btn">Obnovit</button>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="form-group">
                    <label for="filter-status">Status</label>
                    <select id="filter-status" class="form-control">
                        <option value="">Vše</option>
                        <option value="importovano">Importováno</option>
                        <option value="zpracovano">Zpracováno</option>
                        <option value="schvaleno">Schváleno</option>
                        <option value="upraveno">Upraveno</option>
                        <option value="chyba">Chyba</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filter-pv">Typ</label>
                    <select id="filter-pv" class="form-control">
                        <option value="">Vše</option>
                        <option value="P">Příjem (P)</option>
                        <option value="V">Výdaj (V)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filter-date-from">Od data</label>
                    <input type="date" id="filter-date-from" class="form-control">
                </div>
                <div class="form-group">
                    <label for="filter-date-to">Do data</label>
                    <input type="date" id="filter-date-to" class="form-control">
                </div>
                <div class="form-group">
                    <label for="filter-search">Hledat</label>
                    <input type="text" id="filter-search" class="form-control" placeholder="Hledat...">
                </div>
                <div class="form-group" style="display:flex;align-items:flex-end;padding-bottom:2px;">
                    <label style="display:flex;align-items:center;gap:0.375rem;white-space:nowrap;cursor:pointer;font-size:0.85rem;">
                        <input type="checkbox" id="filter-show-inactive">
                        Zobrazit neaktivní
                    </label>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Typ</th>
                            <th>Popis</th>
                            <th>Protistrana</th>
                            <th class="text-right">Částka</th>
                            <th>Status</th>
                            <th>P/V</th>
                            <th>Kategorie</th>
                            <th style="text-align:center">Aktivní</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="transactions-table">
                        <tr>
                            <td colspan="10" class="text-center text-muted">Načítání...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination">
                <button id="prev-page" disabled>&laquo; Předchozí</button>
                <span class="page-info" id="page-info">Strana 1</span>
                <button id="next-page">Další &raquo;</button>
            </div>
        </div>
    </main>

    <!-- Add Transaction Modal -->
    <div class="modal-overlay hidden" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Nová transakce</h2>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modal-alert"></div>
                <div class="form-grid">
                    <!-- Basic -->
                    <div class="section-label">Základní</div>
                    <div class="form-group">
                        <label for="m-datum">Datum *</label>
                        <input type="date" id="m-datum" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="m-castka">Částka *</label>
                        <input type="number" id="m-castka" class="form-control" step="0.01" placeholder="1 234.56" required>
                    </div>
                    <div class="form-group">
                        <label for="m-pv">P/V</label>
                        <select id="m-pv" class="form-control">
                            <option value="">Auto</option>
                            <option value="P">Příjem (P)</option>
                            <option value="V">Výdaj (V)</option>
                        </select>
                    </div>

                    <!-- Description -->
                    <div class="section-label">Popis</div>
                    <div class="form-group span-2">
                        <label for="m-poznamka">Poznámka / Zpráva</label>
                        <input type="text" id="m-poznamka" class="form-control" placeholder="Popis transakce">
                    </div>
                    <div class="form-group">
                        <label for="m-vs">Variabilní symbol</label>
                        <input type="text" id="m-vs" class="form-control" placeholder="VS">
                    </div>
                    <div class="form-group span-2">
                        <label for="m-protiucet">Název protistrany</label>
                        <input type="text" id="m-protiucet" class="form-control" placeholder="Název společnosti">
                    </div>
                    <div class="form-group">
                        <label for="m-typ">Typ</label>
                        <input type="text" id="m-typ" class="form-control" placeholder="např. Úhrada">
                    </div>

                    <!-- Categorization -->
                    <div class="section-label">Kategorizace</div>
                    <div class="form-group">
                        <label for="m-vn">V/N (Výnosy/Náklady)</label>
                        <select id="m-vn" class="form-control">
                            <option value="-">— (žádné)</option>
                            <option value="V">Výnosy (V)</option>
                            <option value="N">Náklady (N)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="m-druh">Druh</label>
                        <input type="text" id="m-druh" class="form-control" placeholder="např. fixní">
                    </div>
                    <div class="form-group">
                        <label for="m-detail">Detail</label>
                        <input type="text" id="m-detail" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="m-dane" style="margin-right:0.375rem;" checked>
                            Daně
                        </label>
                    </div>

                    <!-- KMEN -->
                    <div class="section-label">Rozdělení KMEN</div>
                    <div class="form-group">
                        <label for="m-kmen">KMEN</label>
                        <select id="m-kmen" class="form-control">
                            <option value="">—</option>
                            <option value="MH">MH</option>
                            <option value="SK">ŠK</option>
                            <option value="XP">XP</option>
                            <option value="FR">FR</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="m-mh">MH %</label>
                        <input type="number" id="m-mh" class="form-control" step="0.01" min="0" max="100" value="0">
                    </div>
                    <div class="form-group">
                        <label for="m-sk">ŠK %</label>
                        <input type="number" id="m-sk" class="form-control" step="0.01" min="0" max="100" value="0">
                    </div>
                    <div class="form-group">
                        <label for="m-xp">XP %</label>
                        <input type="number" id="m-xp" class="form-control" step="0.01" min="0" max="100" value="0">
                    </div>
                    <div class="form-group">
                        <label for="m-fr">FR %</label>
                        <input type="number" id="m-fr" class="form-control" step="0.01" min="0" max="100" value="0">
                    </div>

                    <!-- Project / Product -->
                    <div class="section-label">Projekt / Produkt</div>
                    <div class="form-group">
                        <label for="m-projekt">Projekt</label>
                        <select id="m-projekt" class="form-control">
                            <option value="">—</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="m-produkt">Produkt</label>
                        <select id="m-produkt" class="form-control">
                            <option value="">—</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="m-podskupina">Podskupina</label>
                        <select id="m-podskupina" class="form-control">
                            <option value="">—</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display:flex;justify-content:space-between;align-items:center;">
                <div class="modal-nav" id="modal-nav" style="display:none;gap:0.5rem;">
                    <button class="btn btn-outline btn-sm" id="modal-prev" title="Předchozí transakce">&laquo; Předchozí</button>
                    <span id="modal-nav-info" style="font-size:0.8rem;color:var(--gray-500);min-width:60px;text-align:center;"></span>
                    <button class="btn btn-outline btn-sm" id="modal-next" title="Další transakce">Další &raquo;</button>
                </div>
                <div style="display:flex;gap:0.5rem;">
                    <button class="btn btn-outline" id="modal-cancel">Zrušit</button>
                    <button class="btn btn-primary" id="modal-save">Uložit transakci</button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Check auth
        if (!requireAuth()) {
            throw new Error('Not authenticated');
        }

        setupNavbar();

        // Show admin-only actions for admin users
        const currentUser = auth.getUser();
        if (currentUser && currentUser.role === 'admin') {
            document.getElementById('admin-actions').style.display = 'flex';
        }

        // State
        let currentPage = 1;
        let totalPages = 1;
        let totalCount = 0;

        // DOM elements
        const tableBody = document.getElementById('transactions-table');
        const alertContainer = document.getElementById('alert-container');
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const pageInfo = document.getElementById('page-info');
        const refreshBtn = document.getElementById('refresh-btn');

        // Filter elements
        const filterStatus = document.getElementById('filter-status');
        const filterPV = document.getElementById('filter-pv');
        const filterDateFrom = document.getElementById('filter-date-from');
        const filterDateTo = document.getElementById('filter-date-to');
        const filterSearch = document.getElementById('filter-search');
        const filterShowInactive = document.getElementById('filter-show-inactive');

        // Load stats
        async function loadStats() {
            try {
                const stats = await api.getTransactionStats();

                document.getElementById('stat-total').textContent =
                    stats.total_count?.toLocaleString('cs-CZ') || '0';
                document.getElementById('stat-income').textContent =
                    utils.formatCurrency(stats.total_income || 0);
                document.getElementById('stat-expense').textContent =
                    utils.formatCurrency(stats.total_expense || 0);
                document.getElementById('stat-uncategorized').textContent =
                    stats.uncategorized_count?.toLocaleString('cs-CZ') || '0';
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load transactions
        async function loadTransactions() {
            const params = {
                page: currentPage
            };

            if (filterStatus.value) params.status = filterStatus.value;
            if (filterPV.value) params.prijem_vydaj = filterPV.value;
            if (filterDateFrom.value) params.date_from = filterDateFrom.value;
            if (filterDateTo.value) params.date_to = filterDateTo.value;
            if (filterSearch.value) params.search = filterSearch.value;
            if (filterShowInactive.checked) params.show_inactive = 'true';

            try {
                const data = await api.getTransactions(params);

                totalCount = data.count || 0;
                totalPages = Math.ceil(totalCount / 50) || 1;

                renderTransactions(data.results || []);
                updatePagination();
            } catch (error) {
                console.error('Failed to load transactions:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center text-danger">
                            Nepodařilo se načíst transakce. ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Render transactions table
        function renderTransactions(transactions) {
            if (transactions.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center text-muted">
                            Žádné transakce nenalezeny.
                        </td>
                    </tr>
                `;
                return;
            }

            visibleTxnIds = transactions.map(txn => txn.id);

            tableBody.innerHTML = transactions.map(txn => {
                const amount = parseFloat(txn.castka);
                const amountClass = amount >= 0 ? 'positive' : 'negative';
                const rowStyle = txn.is_active === false ? 'opacity:0.5;' : '';

                return `
                    <tr style="${rowStyle}">
                        <td>${utils.formatDate(txn.datum)}</td>
                        <td>${utils.escapeHtml(txn.typ) || '-'}</td>
                        <td title="${utils.escapeHtml(txn.poznamka_zprava)}">
                            ${utils.escapeHtml(txn.poznamka_zprava?.substring(0, 40))}${txn.poznamka_zprava?.length > 40 ? '...' : ''}
                        </td>
                        <td>${utils.escapeHtml(txn.nazev_protiuctu) || utils.escapeHtml(txn.nazev_merchanta) || '-'}</td>
                        <td class="text-right">
                            <span class="amount ${amountClass}">
                                ${utils.formatCurrency(txn.castka)}
                            </span>
                        </td>
                        <td>${utils.getStatusBadge(txn.status)}</td>
                        <td>${utils.getPVBadge(txn.prijem_vydaj)}</td>
                        <td>${utils.escapeHtml(txn.druh) || '-'}</td>
                        <td style="text-align:center"><input type="checkbox" class="active-toggle" data-id="${txn.id}" ${txn.is_active !== false ? 'checked' : ''} title="Přepnout aktivní/neaktivní"></td>
                        <td><button class="btn-edit" data-id="${txn.id}" title="Upravit"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button></td>
                    </tr>
                `;
            }).join('');
        }

        // Update pagination
        function updatePagination() {
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            pageInfo.textContent = `Strana ${currentPage} z ${totalPages} (celkem ${totalCount})`;
        }

        // Event listeners
        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                loadTransactions();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                loadTransactions();
            }
        });

        refreshBtn.addEventListener('click', () => {
            loadStats();
            loadTransactions();
        });

        // Export Excel
        const exportBtn = document.getElementById('export-btn');
        exportBtn.addEventListener('click', async () => {
            const params = new URLSearchParams();
            if (filterStatus.value) params.set('status', filterStatus.value);
            if (filterPV.value) params.set('prijem_vydaj', filterPV.value);
            if (filterDateFrom.value) params.set('date_from', filterDateFrom.value);
            if (filterDateTo.value) params.set('date_to', filterDateTo.value);
            if (filterSearch.value) params.set('search', filterSearch.value);

            const url = `${API_BASE}/transactions/export-excel/?${params.toString()}`;
            exportBtn.disabled = true;
            exportBtn.textContent = 'Exportování...';

            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${auth.getToken()}` }
                });

                if (!response.ok) throw new Error('Export selhal');

                const blob = await response.blob();
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'transakce_export.xlsx';
                link.click();
                URL.revokeObjectURL(link.href);

                utils.showAlert(alertContainer, `Exportováno ${totalCount} transakcí do Excelu.`, 'success');
            } catch (error) {
                utils.showAlert(alertContainer, `Export selhal: ${error.message}`, 'danger');
            } finally {
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export Excel';
            }
        });

        // Filter change handlers
        let filterTimeout;
        function onFilterChange() {
            currentPage = 1;
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(loadTransactions, 300);
        }

        filterStatus.addEventListener('change', onFilterChange);
        filterPV.addEventListener('change', onFilterChange);
        filterDateFrom.addEventListener('change', onFilterChange);
        filterDateTo.addEventListener('change', onFilterChange);
        filterSearch.addEventListener('input', onFilterChange);
        filterShowInactive.addEventListener('change', onFilterChange);

        // Active/inactive toggle handler (event delegation)
        tableBody.addEventListener('change', async (e) => {
            const checkbox = e.target.closest('.active-toggle');
            if (!checkbox) return;
            const txnId = checkbox.dataset.id;
            const newState = checkbox.checked;
            try {
                await api.updateTransaction(txnId, { is_active: newState });
                // Reload to reflect row style change
                loadTransactions();
            } catch (err) {
                checkbox.checked = !newState; // revert
                utils.showAlert(alertContainer, `Aktualizace selhala: ${err.message}`, 'danger');
            }
        });

        // Initial load
        loadStats();
        loadTransactions();

        // =====================================================================
        // ADMIN ACTIONS (backup/restore/wipe)
        // =====================================================================
        const adminExportBtn = document.getElementById('admin-export-btn');
        const adminImportBtn = document.getElementById('admin-import-btn');
        const adminImportFile = document.getElementById('admin-import-file');
        const adminWipeBtn = document.getElementById('admin-wipe-btn');

        // Export backup (JSON)
        adminExportBtn.addEventListener('click', async () => {
            adminExportBtn.disabled = true;
            adminExportBtn.textContent = 'Exportování...';
            try {
                const response = await api.exportBackup();
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'herowizzard_backup.json';
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                utils.showAlert(alertContainer, 'Záloha úspěšně exportována.', 'success');
            } catch (err) {
                utils.showAlert(alertContainer, `Export selhal: ${err.message}`, 'danger');
            } finally {
                adminExportBtn.disabled = false;
                adminExportBtn.textContent = 'Export zálohy';
            }
        });

        // Import backup (JSON)
        adminImportBtn.addEventListener('click', () => adminImportFile.click());
        adminImportFile.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (!confirm(`Importovat transakce ze souboru "${file.name}"?\n\nDuplikáty (stejné ID) budou přeskočeny.`)) {
                adminImportFile.value = '';
                return;
            }
            adminImportBtn.disabled = true;
            adminImportBtn.textContent = 'Importování...';
            try {
                const result = await api.importBackup(file);
                utils.showAlert(alertContainer,
                    `Import dokončen: ${result.imported} importováno, ${result.skipped} přeskočeno (duplikáty), ${result.errors} chyb.`,
                    result.errors > 0 ? 'warning' : 'success'
                );
                loadStats();
                loadTransactions();
            } catch (err) {
                utils.showAlert(alertContainer, `Import selhal: ${err.message}`, 'danger');
            } finally {
                adminImportBtn.disabled = false;
                adminImportBtn.textContent = 'Import zálohy';
                adminImportFile.value = '';
            }
        });

        // Wipe all transactions
        adminWipeBtn.addEventListener('click', async () => {
            const confirmText = prompt(
                'Tímto soft-delete smažete VŠECHNY transakce.\n\n' +
                'Napište "WIPE" pro potvrzení:'
            );
            if (confirmText !== 'WIPE') return;

            adminWipeBtn.disabled = true;
            adminWipeBtn.textContent = 'Mazání...';
            try {
                const result = await api.wipeAllTransactions();
                utils.showAlert(alertContainer,
                    `${result.wiped_count} transakcí soft-delete smazáno.`,
                    'success'
                );
                loadStats();
                loadTransactions();
            } catch (err) {
                utils.showAlert(alertContainer, `Mazání selhalo: ${err.message}`, 'danger');
            } finally {
                adminWipeBtn.disabled = false;
                adminWipeBtn.textContent = 'Smazat vše';
            }
        });

        // =====================================================================
        // ADD / EDIT TRANSACTION MODAL
        // =====================================================================
        const modalOverlay        = document.getElementById('modal-overlay');
        const modalClose          = document.getElementById('modal-close');
        const modalCancel         = document.getElementById('modal-cancel');
        const modalSave           = document.getElementById('modal-save');
        const addTxnBtn           = document.getElementById('add-txn-btn');
        const modalAlertContainer = document.getElementById('modal-alert');
        const modalTitle          = document.querySelector('.modal-header h2');

        let editingTxnId = null;   // null = create mode, UUID string = edit mode
        let visibleTxnIds = [];    // IDs of currently rendered transactions (for prev/next)
        let editingIndex = -1;     // index within visibleTxnIds

        // Navigation elements
        const modalNav     = document.getElementById('modal-nav');
        const modalPrev    = document.getElementById('modal-prev');
        const modalNext    = document.getElementById('modal-next');
        const modalNavInfo = document.getElementById('modal-nav-info');

        function updateModalNav() {
            if (!editingTxnId || visibleTxnIds.length === 0) {
                modalNav.style.display = 'none';
                return;
            }
            modalNav.style.display = 'flex';
            modalPrev.disabled = (editingIndex <= 0);
            modalNext.disabled = (editingIndex >= visibleTxnIds.length - 1);
            modalNavInfo.textContent = `${editingIndex + 1} / ${visibleTxnIds.length}`;
        }

        // Update save button text based on context
        function updateSaveButtonText() {
            if (!editingTxnId) {
                // Create mode
                modalSave.textContent = 'Uložit transakci';
            } else if (editingIndex < visibleTxnIds.length - 1) {
                // Edit mode, not last transaction
                modalSave.textContent = 'Uložit a otevřít další';
            } else {
                // Edit mode, last transaction
                modalSave.textContent = 'Uložit transakci';
            }
        }

        async function navigateToTransaction(newIndex) {
            if (newIndex < 0 || newIndex >= visibleTxnIds.length) return;
            try {
                const txn = await api.getTransaction(visibleTxnIds[newIndex]);
                editingTxnId = txn.id;
                editingIndex = newIndex;
                modalAlertContainer.innerHTML = '';
                populateModalFromTransaction(txn);
                setBankFieldsDisabled(true);
                modalTitle.textContent = 'Upravit transakci';
                updateModalNav();
                updateSaveButtonText();
            } catch (err) {
                utils.showAlert(modalAlertContainer, `Nepodařilo se načíst transakci: ${err.message}`, 'danger');
            }
        }

        modalPrev.addEventListener('click', () => navigateToTransaction(editingIndex - 1));
        modalNext.addEventListener('click', () => navigateToTransaction(editingIndex + 1));

        // Lookup caches — populated once on first open
        let lookupProjects  = [];
        let lookupProducts  = [];
        let lookupSubgroups = [];
        let lookupsLoaded   = false;

        async function loadLookups() {
            if (lookupsLoaded) return;
            try {
                const [projData, prodData, subData] = await Promise.all([
                    api.getProjects(),
                    api.getProducts(),
                    api.getSubgroups()
                ]);
                lookupProjects  = projData.results || projData || [];
                lookupProducts  = prodData.results || prodData || [];
                lookupSubgroups = subData.results  || subData  || [];
                lookupsLoaded = true;
                populateSelect('m-projekt',  lookupProjects,  'id', 'name');
                populateSelect('m-produkt',  lookupProducts,  'id', 'name');
            } catch (e) {
                console.error('Failed to load lookups:', e);
            }
        }

        function populateSelect(elementId, items, valKey, labelKey) {
            const sel = document.getElementById(elementId);
            sel.innerHTML = '<option value="">—</option>' +
                items.map(item => `<option value="${item[valKey]}">${item[labelKey]}</option>`).join('');
        }

        // When Produkt changes, filter Podskupina by selected product
        document.getElementById('m-produkt').addEventListener('change', function () {
            const prodId = this.value;
            const filtered = prodId
                ? lookupSubgroups.filter(s => s.product === prodId || s.product_id === prodId)
                : [];
            populateSelect('m-podskupina', filtered, 'id', 'name');
            document.getElementById('m-podskupina').value = '';
        });

        // --- helpers --------------------------------------------------------
        const BANK_FIELD_IDS = ['m-datum', 'm-castka', 'm-poznamka', 'm-vs', 'm-protiucet', 'm-typ'];

        function setBankFieldsDisabled(disabled) {
            BANK_FIELD_IDS.forEach(id => { document.getElementById(id).disabled = disabled; });
        }

        function resetModalForm() {
            document.getElementById('m-datum').value    = '';
            document.getElementById('m-castka').value   = '';
            document.getElementById('m-poznamka').value = '';
            document.getElementById('m-vs').value       = '';
            document.getElementById('m-protiucet').value= '';
            document.getElementById('m-typ').value      = '';
            document.getElementById('m-pv').value       = '';
            document.getElementById('m-vn').value       = '-';
            document.getElementById('m-dane').checked   = true;
            document.getElementById('m-druh').value     = '';
            document.getElementById('m-detail').value   = '';
            document.getElementById('m-kmen').value     = '';
            document.getElementById('m-mh').value       = '0';
            document.getElementById('m-sk').value       = '0';
            document.getElementById('m-xp').value       = '0';
            document.getElementById('m-fr').value       = '0';
            document.getElementById('m-projekt').value  = '';
            document.getElementById('m-produkt').value  = '';
            document.getElementById('m-podskupina').value = '';
        }

        function populateModalFromTransaction(txn) {
            document.getElementById('m-datum').value     = txn.datum || '';
            document.getElementById('m-castka').value    = txn.castka || '';
            document.getElementById('m-poznamka').value  = txn.poznamka_zprava || '';
            document.getElementById('m-vs').value        = txn.variabilni_symbol || '';
            document.getElementById('m-protiucet').value = txn.nazev_protiuctu || '';
            document.getElementById('m-typ').value       = txn.typ || '';
            document.getElementById('m-pv').value        = txn.prijem_vydaj || '';
            document.getElementById('m-vn').value        = txn.vlastni_nevlastni || '-';
            document.getElementById('m-dane').checked    = !!txn.dane;
            document.getElementById('m-druh').value      = txn.druh || '';
            document.getElementById('m-detail').value    = txn.detail || '';
            document.getElementById('m-kmen').value      = txn.kmen || '';
            document.getElementById('m-mh').value        = txn.mh_pct || '0';
            document.getElementById('m-sk').value        = txn.sk_pct || '0';
            document.getElementById('m-xp').value        = txn.xp_pct || '0';
            document.getElementById('m-fr').value        = txn.fr_pct || '0';
            document.getElementById('m-projekt').value   = txn.projekt || '';
            document.getElementById('m-produkt').value   = txn.produkt || '';
            // trigger produkt change so podskupina options are filtered first
            document.getElementById('m-produkt').dispatchEvent(new Event('change'));
            // then set the actual podskupina value (change handler resets it to '')
            document.getElementById('m-podskupina').value = txn.podskupina || '';
        }

        // --- open create modal ----------------------------------------------
        addTxnBtn.addEventListener('click', async () => {
            await loadLookups();
            editingTxnId = null;
            editingIndex = -1;
            modalAlertContainer.innerHTML = '';
            resetModalForm();
            setBankFieldsDisabled(false);
            modalTitle.textContent = 'Nová transakce';
            document.getElementById('m-datum').value = new Date().toISOString().split('T')[0];
            updateModalNav();
            updateSaveButtonText();
            modalOverlay.classList.remove('hidden');
        });

        // --- open edit modal (event delegation on tbody) --------------------
        tableBody.addEventListener('click', async (e) => {
            const btn = e.target.closest('.btn-edit');
            if (!btn) return;
            try {
                const txnId = btn.dataset.id;
                const txn = await api.getTransaction(txnId);
                await loadLookups();
                editingTxnId = txn.id;
                editingIndex = visibleTxnIds.indexOf(txnId);
                modalAlertContainer.innerHTML = '';
                populateModalFromTransaction(txn);
                setBankFieldsDisabled(true);
                modalTitle.textContent = 'Upravit transakci';
                updateModalNav();
                updateSaveButtonText();
                modalOverlay.classList.remove('hidden');
            } catch (err) {
                utils.showAlert(alertContainer, `Nepodařilo se načíst transakci: ${err.message}`, 'danger');
            }
        });

        // --- close modal ----------------------------------------------------
        function closeModal() {
            modalOverlay.classList.add('hidden');
        }
        modalClose.addEventListener('click', closeModal);
        modalCancel.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) closeModal();
        });

        // --- save (create or edit) ------------------------------------------
        modalSave.addEventListener('click', async () => {
            const datum  = document.getElementById('m-datum').value;
            const castka = document.getElementById('m-castka').value;

            if (!datum || !castka) {
                utils.showAlert(modalAlertContainer, 'Datum a Částka jsou povinné.', 'danger');
                return;
            }

            // P/V validation: negative amount cannot be Příjem, positive cannot be Výdaj
            const amountVal = parseFloat(castka);
            const pvVal = document.getElementById('m-pv').value;
            if (pvVal === 'P' && amountVal < 0) {
                utils.showAlert(modalAlertContainer, 'Záporná hodnota není příjem.', 'danger');
                return;
            }
            if (pvVal === 'V' && amountVal > 0) {
                utils.showAlert(modalAlertContainer, 'Kladná hodnota není výdaj.', 'danger');
                return;
            }

            // App-column fields shared by both create and edit
            const appFields = {
                prijem_vydaj:      document.getElementById('m-pv').value,
                vlastni_nevlastni: document.getElementById('m-vn').value,
                dane:              document.getElementById('m-dane').checked,
                druh:              document.getElementById('m-druh').value,
                detail:            document.getElementById('m-detail').value,
                kmen:              document.getElementById('m-kmen').value,
                mh_pct:            document.getElementById('m-mh').value  || '0',
                sk_pct:            document.getElementById('m-sk').value  || '0',
                xp_pct:            document.getElementById('m-xp').value  || '0',
                fr_pct:            document.getElementById('m-fr').value  || '0',
                projekt:           document.getElementById('m-projekt').value      || null,
                produkt:           document.getElementById('m-produkt').value      || null,
                podskupina:        document.getElementById('m-podskupina').value   || null,
            };

            modalSave.disabled = true;
            modalSave.textContent = 'Ukládání...';

            try {
                if (editingTxnId) {
                    // --- EDIT: PATCH app fields only (bank fields are read-only on server) ---
                    await api.updateTransaction(editingTxnId, appFields);
                    utils.showAlert(alertContainer, 'Transakce úspěšně aktualizována.', 'success');

                    // Auto-navigate to next transaction if not the last one
                    if (editingIndex < visibleTxnIds.length - 1) {
                        loadStats();
                        loadTransactions();
                        await navigateToTransaction(editingIndex + 1);
                        modalSave.disabled = false;
                        updateSaveButtonText();
                        return;
                    }
                } else {
                    // --- CREATE: full payload including bank fields ---
                    const payload = {
                        datum:             datum,
                        castka:            castka,
                        poznamka_zprava:   document.getElementById('m-poznamka').value,
                        nazev_protiuctu:   document.getElementById('m-protiucet').value,
                        variabilni_symbol: document.getElementById('m-vs').value,
                        typ:               document.getElementById('m-typ').value,
                        ...appFields,
                    };
                    await api.createTransaction(payload);
                    utils.showAlert(alertContainer, 'Transakce úspěšně vytvořena.', 'success');
                }
                closeModal();
                loadStats();
                loadTransactions();
            } catch (error) {
                let msg = error.message;
                if (error.data) {
                    const details = Object.entries(error.data)
                        .map(([field, msgs]) => `${field}: ${Array.isArray(msgs) ? msgs.join(', ') : msgs}`)
                        .join('; ');
                    if (details) msg = details;
                }
                utils.showAlert(modalAlertContainer, `Chyba: ${msg}`, 'danger');
            } finally {
                modalSave.disabled = false;
                updateSaveButtonText();
            }
        });
    </script>
</body>
</html>
