<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nápověda - HeroWizzard</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .help-section { margin-bottom: 2rem; }
        .help-section h2 { color: var(--primary); margin-bottom: 0.75rem; border-bottom: 2px solid var(--gray-200); padding-bottom: 0.5rem; }
        .help-section h3 { color: var(--gray-700); margin: 1rem 0 0.5rem; }
        .help-section p, .help-section li { line-height: 1.7; color: var(--gray-700); }
        .help-section ul, .help-section ol { padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .help-section li { margin-bottom: 0.35rem; }
        .help-toc { background: white; border-radius: 0.5rem; padding: 1.25rem 1.5rem; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .help-toc h3 { margin-top: 0; }
        .help-toc ul { list-style: none; padding-left: 0; }
        .help-toc li { margin-bottom: 0.25rem; }
        .help-toc a { color: var(--primary); text-decoration: none; }
        .help-toc a:hover { text-decoration: underline; }
        .info-box { background: #eff6ff; border-left: 4px solid var(--primary); padding: 0.75rem 1rem; margin: 0.75rem 0; border-radius: 0 0.25rem 0.25rem 0; }
        .warning-box { background: #fef3c7; border-left: 4px solid var(--warning); padding: 0.75rem 1rem; margin: 0.75rem 0; border-radius: 0 0.25rem 0.25rem 0; }
        .tip-box { background: #f0fdf4; border-left: 4px solid var(--success); padding: 0.75rem 1rem; margin: 0.75rem 0; border-radius: 0 0.25rem 0.25rem 0; }
        code { background: var(--gray-100); padding: 0.125rem 0.375rem; border-radius: 3px; font-size: 0.9em; }
        .role-table td, .role-table th { padding: 0.5rem 0.75rem; text-align: left; }
        .key-value { display: grid; grid-template-columns: 160px 1fr; gap: 0.25rem 1rem; margin: 0.5rem 0; }
        .key-value dt { font-weight: 600; color: var(--gray-700); }
        .key-value dd { color: var(--gray-500); margin: 0; }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="container">
            <h1 id="app-title">HeroWizzard</h1>
            <nav>
                <a href="dashboard.html">Přehled</a>
                <a href="upload.html">Import CSV</a>
                <a href="categories.html">Pravidla kategorií</a>
                <a href="help.html">Nápověda</a>
            </nav>
            <div class="user-info">
                <span id="user-info">Načítání...</span>
                <button class="logout-btn" id="logout-btn">Odhlásit</button>
            </div>
        </div>
    </header>

    <main class="container">
        <div id="alert-container"></div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Uživatelská příručka</h2>
            </div>

            <!-- Table of Contents -->
            <div class="help-toc">
                <h3>Obsah</h3>
                <ul>
                    <li><a href="#overview">1. Přehled aplikace</a></li>
                    <li><a href="#roles">2. Uživatelské role a oprávnění</a></li>
                    <li><a href="#dashboard">3. Přehled (Dashboard)</a></li>
                    <li><a href="#transactions">4. Práce s transakcemi</a></li>
                    <li><a href="#import">5. Import CSV</a></li>
                    <li><a href="#categories">6. Pravidla kategorií</a></li>
                    <li><a href="#export">7. Export do Excelu</a></li>
                </ul>
            </div>

            <!-- 1. Overview -->
            <div class="help-section" id="overview">
                <h2>1. Přehled aplikace</h2>
                <p>
                    HeroWizzard je systém správy financí pro sledování a kategorizaci bankovních transakcí.
                    Podporuje import CSV výpisů z více českých bank (Creditas, Raiffeisen),
                    import faktur z iDokladu a poskytuje nástroje pro kategorizaci, rozdělení nákladů dle KMEN
                    a reportování.
                </p>
                <div class="info-box">
                    <strong>Prostředí:</strong> Aplikace běží ve třech oddělených prostředích &mdash;
                    <strong>TEST</strong> (pro testování), <strong>STAGE</strong> (pro kontrolu před nasazením)
                    a <strong>PRODUCTION</strong> (ostrá data). Barevný štítek vedle loga ukazuje,
                    ve kterém prostředí se nacházíte.
                </div>
            </div>

            <!-- 2. Roles -->
            <div class="help-section" id="roles">
                <h2>2. Uživatelské role a oprávnění</h2>
                <p>Každému uživateli je přiřazena jedna ze čtyř rolí, zobrazená jako barevný štítek v pravém horním rohu:</p>
                <div class="table-container">
                    <table class="role-table">
                        <thead>
                            <tr>
                                <th>Role</th>
                                <th>Barva štítku</th>
                                <th>Oprávnění</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Admin</strong></td>
                                <td><span style="color:#e74c3c;font-weight:600">Červená</span></td>
                                <td>Plný přístup: všechny CRUD operace, Django admin panel, správa uživatelů, import, export, pravidla kategorií</td>
                            </tr>
                            <tr>
                                <td><strong>Manažer</strong></td>
                                <td><span style="color:#2563eb;font-weight:600">Modrá</span></td>
                                <td>Import CSV souborů, vytváření/úprava transakcí, správa pravidel kategorií, export dat, zobrazení reportů</td>
                            </tr>
                            <tr>
                                <td><strong>Účetní</strong></td>
                                <td><span style="color:#f59e0b;font-weight:600">Žlutá</span></td>
                                <td>Úprava a kategorizace transakcí, nastavení KMEN rozdělení, export dat, zobrazení reportů</td>
                            </tr>
                            <tr>
                                <td><strong>Čtenář</strong></td>
                                <td><span style="color:#6b7280;font-weight:600">Šedá</span></td>
                                <td>Pouze čtení: zobrazení přehledu, transakcí, použití filtrů a vyhledávání</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 3. Dashboard -->
            <div class="help-section" id="dashboard">
                <h2>3. Přehled (Dashboard)</h2>

                <h3>Statistické karty</h3>
                <p>Horní řada zobrazuje čtyři souhrnné karty:</p>
                <ul>
                    <li><strong>Celkem transakcí</strong> &mdash; počet všech aktivních transakcí</li>
                    <li><strong>Celkové příjmy</strong> &mdash; součet všech kladných částek (zelená)</li>
                    <li><strong>Celkové výdaje</strong> &mdash; součet všech záporných částek (červená)</li>
                    <li><strong>Nezařazené</strong> &mdash; transakce bez přiřazeného P/V nebo kategorie</li>
                </ul>
                <div class="info-box">
                    Statistiky zahrnují pouze <strong>aktivní</strong> transakce. Neaktivní transakce jsou vyloučeny ze všech souhrnných čísel.
                </div>

                <h3>Filtry</h3>
                <p>Použijte panel filtrů nad tabulkou transakcí pro zúžení výsledků:</p>
                <ul>
                    <li><strong>Status</strong> &mdash; filtrování podle stavu zpracování (Importováno, Zpracováno, Schváleno atd.)</li>
                    <li><strong>Typ (P/V)</strong> &mdash; Příjem (P) nebo Výdaj (V)</li>
                    <li><strong>Rozsah dat</strong> &mdash; Od / Do data</li>
                    <li><strong>Hledat</strong> &mdash; textové vyhledávání v popisu, protistraně, obchodníkovi, variabilním symbolu</li>
                    <li><strong>Zobrazit neaktivní</strong> &mdash; po zaškrtnutí zobrazí i deaktivované transakce (zobrazí se ztlumeně)</li>
                </ul>

                <h3>Sloupce tabulky transakcí</h3>
                <ul>
                    <li><strong>Datum</strong> &mdash; datum transakce z bankovního výpisu</li>
                    <li><strong>Typ</strong> &mdash; typ transakce z banky</li>
                    <li><strong>Popis</strong> &mdash; zpráva/poznámka z banky (najeďte myší pro celý text)</li>
                    <li><strong>Protistrana</strong> &mdash; název protistrany nebo obchodníka</li>
                    <li><strong>Částka</strong> &mdash; částka transakce v Kč (zelená = kladná, červená = záporná)</li>
                    <li><strong>Status</strong> &mdash; štítek stavu zpracování</li>
                    <li><strong>P/V</strong> &mdash; Příjem (zelená) nebo Výdaj (červená)</li>
                    <li><strong>Kategorie</strong> &mdash; přiřazená kategorie (Druh)</li>
                    <li><strong>Aktivní</strong> &mdash; zaškrtávací políčko pro přepnutí stavu aktivní/neaktivní (viz níže)</li>
                    <li><strong>Upravit</strong> &mdash; ikona tužky pro otevření editačního modálu</li>
                </ul>

                <h3>Aktivní / Neaktivní transakce</h3>
                <p>Každá transakce má zaškrtávací políčko <strong>Aktivní</strong>:</p>
                <ul>
                    <li><strong>Zaškrtnuto (aktivní)</strong> &mdash; transakce je zahrnuta ve statistikách, reportech a Excel exportech</li>
                    <li><strong>Nezaškrtnuto (neaktivní)</strong> &mdash; transakce je vyloučena z exportů a ve výchozím nastavení skryta. Použijte pro "soft-delete" transakcí, které chcete ponechat v databázi, ale nezahrnovat do reportů</li>
                    <li>Pro zobrazení neaktivních transakcí zaškrtněte filtr <strong>"Zobrazit neaktivní"</strong>. Neaktivní řádky se zobrazí ztlumeně (50% průhlednost)</li>
                    <li>Transakci můžete znovu aktivovat zaškrtnutím políčka Aktivní při zapnutém filtru "Zobrazit neaktivní"</li>
                </ul>
                <div class="tip-box">
                    <strong>Tip:</strong> Použijte přepínač Aktivní pro vyloučení testovacích transakcí, duplikátů nebo irelevantních položek z vašich reportů bez trvalého smazání.
                </div>

                <h3>Stránkování</h3>
                <p>Transakce se zobrazují po 50 na stránku. Použijte tlačítka Předchozí/Další pro navigaci. Informace o stránce ukazují aktuální stránku, celkový počet stránek a celkový počet transakcí.</p>
            </div>

            <!-- 4. Transactions -->
            <div class="help-section" id="transactions">
                <h2>4. Práce s transakcemi</h2>

                <h3>Vytvoření nové transakce</h3>
                <p>Klikněte na <strong>"+ Přidat transakci"</strong> pro otevření formuláře. Pole jsou organizována do sekcí:</p>

                <h4 style="margin-top:0.75rem;color:var(--gray-700);">Základní (povinné)</h4>
                <ul>
                    <li><strong>Datum</strong> (povinné) &mdash; výchozí hodnota je dnešní datum</li>
                    <li><strong>Částka</strong> (povinné) &mdash; zadejte částku v Kč. Použijte záporné hodnoty pro výdaje (např. <code>-5000</code>)</li>
                    <li><strong>P/V</strong> &mdash; automaticky detekováno ze znaménka částky při ponechání na "Auto": kladná = Příjem (P), záporná = Výdaj (V). Můžete ručně přepsat</li>
                </ul>

                <h4 style="margin-top:0.75rem;color:var(--gray-700);">Popis (volitelné)</h4>
                <ul>
                    <li><strong>Poznámka / Zpráva</strong> &mdash; volný textový popis</li>
                    <li><strong>Variabilní symbol (VS)</strong> &mdash; variabilní symbol pro párování s fakturami</li>
                    <li><strong>Název protistrany</strong> &mdash; název protistrany</li>
                    <li><strong>Typ</strong> &mdash; typ transakce (např. "Úhrada", "Převod")</li>
                </ul>

                <h4 style="margin-top:0.75rem;color:var(--gray-700);">Kategorizace</h4>
                <ul>
                    <li><strong>V/N</strong> &mdash; Výnosy/Náklady. Vyberte "—" pokud není relevantní</li>
                    <li><strong>Druh</strong> (Kategorie) &mdash; hlavní kategorie, např. <code>fixní</code>, <code>variabilní</code>, <code>mzdy</code>, <code>mimořádné</code>, <code>dluhy</code>, <code>převod</code> pro výdaje; <code>projekt_eu</code>, <code>grant_cz</code>, <code>produkt</code>, <code>konference</code> pro příjmy</li>
                    <li><strong>Detail</strong> &mdash; detailní popis podkategorie</li>
                    <li><strong>Daně</strong> &mdash; zaškrtněte pokud je transakce daňově relevantní (výchozí: zaškrtnuto)</li>
                </ul>

                <h4 style="margin-top:0.75rem;color:var(--gray-700);">Rozdělení KMEN</h4>
                <p>Rozdělení KMEN přiřazuje náklady transakce mezi čtyři kmeny:</p>
                <ul>
                    <li><strong>KMEN</strong> &mdash; primární kmen (MH, ŠK, XP, FR)</li>
                    <li><strong>MH%, ŠK%, XP%, FR%</strong> &mdash; procentuální rozdělení mezi kmeny</li>
                </ul>
                <div class="warning-box">
                    <strong>Pravidlo:</strong> Čtyři procenta (MH% + ŠK% + XP% + FR%) musí dát dohromady přesně <strong>100%</strong> nebo být všechna <strong>0%</strong>.
                    Například: <code>100/0/0/0</code>, <code>50/25/25/0</code> nebo <code>0/0/0/0</code>.
                    Hodnoty jako <code>50/10/0/0</code> (součet = 60) budou zamítnuty.
                </div>

                <h4 style="margin-top:0.75rem;color:var(--gray-700);">Projekt / Produkt</h4>
                <ul>
                    <li><strong>Projekt</strong> &mdash; přiřazení k projektu (např. 4CFuture, POLCOM, GAP)</li>
                    <li><strong>Produkt</strong> &mdash; přiřazení k produktu. Při výběru se automaticky filtruje rozbalovací nabídka Podskupina</li>
                    <li><strong>Podskupina</strong> &mdash; podskupina produktu (zobrazuje pouze podskupiny vybraného produktu)</li>
                </ul>

                <h3>Úprava transakce</h3>
                <p>Klikněte na <strong>ikonu tužky</strong> v posledním sloupci pro úpravu. V režimu úpravy:</p>
                <ul>
                    <li><strong>Bankovní pole jsou jen pro čtení</strong> (Datum, Částka, Popis, VS, Protistrana, Typ) &mdash; pocházejí z původního bankovního CSV a nelze je změnit</li>
                    <li><strong>Aplikační pole lze upravovat</strong> &mdash; Status, P/V, V/N, Kategorie, KMEN rozdělení, Projekt, Produkt</li>
                </ul>
                <div class="info-box">
                    <strong>Poznámka:</strong> Ručně vytvořené transakce mají všechna pole upravitelná. Pouze bankou importované transakce mají zamčené bankovní sloupce.
                </div>

                <h3>Navigace mezi transakcemi</h3>
                <p>Při úpravě transakce se tlačítko Uložit změní na <strong>"Uložit a otevřít další"</strong>, pokud nejste na poslední transakci v seznamu. Po uložení se automaticky otevře další transakce k úpravě. Pro poslední transakci v seznamu se zobrazí standardní <strong>"Uložit transakci"</strong>.</p>

                <h3>Validace P/V</h3>
                <p>Systém kontroluje konzistenci mezi částkou a typem P/V:</p>
                <ul>
                    <li>Záporná částka nemůže být nastavena jako Příjem &mdash; zobrazí se chyba <em>"Záporná hodnota není příjem"</em></li>
                    <li>Kladná částka nemůže být nastavena jako Výdaj &mdash; zobrazí se chyba <em>"Kladná hodnota není výdaj"</em></li>
                </ul>
            </div>

            <!-- 5. Import CSV -->
            <div class="help-section" id="import">
                <h2>5. Import CSV</h2>
                <p>Stránka Import poskytuje tři importní karty pro různé zdroje dat:</p>

                <h3>Creditas banka CSV</h3>
                <ul>
                    <li><strong>Kódování:</strong> CP1250 (Windows české kódování)</li>
                    <li><strong>Oddělovač:</strong> Středník (<code>;</code>)</li>
                    <li><strong>Formát data:</strong> DD.MM.RRRR</li>
                    <li><strong>Formát čísel:</strong> Český formát s desetinnou čárkou (<code>1 234,56</code>)</li>
                    <li>Systém automaticky detekuje formát Creditas na základě hlaviček CSV</li>
                </ul>

                <h3>Raiffeisen banka CSV</h3>
                <ul>
                    <li><strong>Kódování:</strong> CP1250</li>
                    <li><strong>Oddělovač:</strong> Středník (<code>;</code>)</li>
                    <li><strong>Formát data:</strong> DD.MM.RRRR HH:MM (včetně času)</li>
                    <li><strong>Speciální:</strong> Raiffeisen exporty obsahují sloupce s názvem obchodníka a městem</li>
                    <li>Systém automaticky detekuje formát Raiffeisen podle specifických hlaviček</li>
                </ul>

                <h3>iDoklad faktura CSV</h3>
                <ul>
                    <li><strong>Kódování:</strong> UTF-8</li>
                    <li>Faktury jsou uloženy v <strong>samostatné tabulce</strong> (ne jako transakce)</li>
                    <li>Budoucí funkce: faktury budou párovány s bankovními transakcemi přes variabilní symbol pro obohacení dat</li>
                </ul>

                <h3>Jak importovat</h3>
                <ol>
                    <li>Klikněte na zónu nahrávání nebo přetáhněte CSV soubor</li>
                    <li>Název souboru se zobrazí pod zónou nahrávání</li>
                    <li>Klikněte na <strong>"Nahrát a importovat"</strong></li>
                    <li>Výsledky zobrazí: Celkem řádků, Importováno, Přeskočeno (duplikáty), Chyby</li>
                </ol>

                <h3>Detekce duplikátů</h3>
                <p>Každá bankovní transakce má unikátní <strong>ID transakce</strong> (id_transakce). Pokud importujete stejný soubor dvakrát, všechny řádky budou <strong>přeskočeny</strong> jako duplikáty &mdash; žádné duplikáty nevzniknou.</p>

                <h3>Automatická kategorizace při importu</h3>
                <p>Při importu transakcí jsou automaticky aplikována všechna aktivní <strong>pravidla kategorií</strong>. Pravidla porovnávají čísla protiúčtů, názvy obchodníků nebo klíčová slova v popisu transakce. Podrobnosti viz sekce Pravidla kategorií.</p>

                <h3>Historie importů</h3>
                <p>Pod importními kartami je tabulka zobrazující všechny předchozí importy s časovými razítky, názvy souborů, statusem a počty. Klikněte na <strong>Obnovit</strong> pro aktualizaci.</p>
            </div>

            <!-- 6. Category Rules -->
            <div class="help-section" id="categories">
                <h2>6. Pravidla kategorií</h2>
                <p>Pravidla kategorií automaticky přiřazují kategorie transakcím při importu a na vyžádání.</p>

                <h3>Hierarchie shody</h3>
                <p>Pravidla se aplikují v přísném pořadí priority podle typu shody:</p>
                <ol>
                    <li><strong>Protiúčet (Číslo účtu)</strong> &mdash; nejvyšší priorita. Porovnává s číslem protiúčtu (např. <code>123456789/0100</code>)</li>
                    <li><strong>Obchodník</strong> &mdash; porovnává s názvem obchodníka z banky</li>
                    <li><strong>Klíčové slovo</strong> &mdash; nejnižší priorita. Porovnává se zprávou transakce, poznámkami a názvem protistrany dohromady</li>
                </ol>
                <div class="info-box">
                    Pokud více pravidel odpovídá stejné transakci, vyhrává pravidlo s <strong>nejvyšší prioritou typu shody</strong> (Protiúčet &gt; Obchodník &gt; Klíčové slovo). V rámci stejného typu shody vyhrává <strong>nižší číslo priority</strong>.
                </div>

                <h3>Režimy shody</h3>
                <ul>
                    <li><strong>Přesná shoda</strong> &mdash; hodnota musí přesně odpovídat (ve výchozím nastavení bez rozlišení velkých/malých písmen)</li>
                    <li><strong>Obsahuje</strong> &mdash; hodnota se musí vyskytovat kdekoli v porovnávaném poli</li>
                    <li><strong>Regulární výraz</strong> &mdash; použijte vzor regulárního výrazu pro pokročilé porovnávání</li>
                </ul>

                <h3>Co mohou pravidla nastavit</h3>
                <p>Jedno pravidlo může nastavit libovolnou kombinaci:</p>
                <ul>
                    <li>P/V (Příjem/Výdaj)</li>
                    <li>V/N (Výnosy/Náklady)</li>
                    <li>Kategorii (Druh) a Detail</li>
                    <li>Přiřazení KMEN a procentuální rozdělení</li>
                    <li>Příznak daní (Daně)</li>
                </ul>

                <h3>Vytvoření pravidla</h3>
                <ol>
                    <li>Klikněte na <strong>"+ Přidat pravidlo"</strong></li>
                    <li>Vyplňte povinná pole: Název, Typ shody, Režim shody, Hodnota shody</li>
                    <li>Nastavte hodnoty kategorií, které chcete aplikovat při shodě pravidla</li>
                    <li>Nastavte <strong>Prioritu</strong> (nižší číslo = vyšší priorita v rámci stejného typu shody, výchozí je 100)</li>
                    <li>Klikněte na <strong>"Uložit pravidlo"</strong></li>
                </ol>

                <h3>Aplikovat na nezařazené</h3>
                <p>Klikněte na <strong>"Použít pravidla na nezařazené"</strong> pro spuštění všech aktivních pravidel na existující transakce bez přiřazeného P/V nebo kategorie. To je užitečné po vytvoření nových pravidel pro zpětnou kategorizaci starých transakcí.</p>

                <div class="tip-box">
                    <strong>Příklad:</strong> Vytvořte pravidlo Protiúčet s hodnotou <code>123456789/0100</code> a nastavte Druh = <code>fixní</code>.
                    Každý budoucí import s tímto protiúčtem bude automaticky kategorizován jako "fixní".
                </div>
            </div>

            <!-- 7. Export -->
            <div class="help-section" id="export">
                <h2>7. Export do Excelu</h2>
                <p>Klikněte na <strong>"Export Excel"</strong> na Přehledu pro stažení Excel (.xlsx) souboru.</p>

                <h3>Co se exportuje</h3>
                <ul>
                    <li>Všechny aktuálně <strong>filtrované</strong> transakce (respektuje filtry Status, Typ, Datum, Hledat)</li>
                    <li><strong>Pouze aktivní transakce</strong> jsou exportovány &mdash; neaktivní transakce jsou vždy vyloučeny bez ohledu na filtr "Zobrazit neaktivní"</li>
                    <li>Excel soubor obsahuje 24 sloupců: Datum, Účet, Typ, Popis, VS, Částka, Protistrana, Obchodník, Město, Status, P/V, V/N, Daně, Kategorie, Detail, KMEN, MH%-FR%, Projekt, Produkt, Podskupina</li>
                </ul>

                <h3>Vlastnosti Excel souboru</h3>
                <ul>
                    <li>Řádek záhlaví má modrý podklad a bílý text</li>
                    <li>Sloupec Částka je formátován jako číslo s 2 desetinnými místy</li>
                    <li>Šířky sloupců se automaticky přizpůsobují obsahu</li>
                    <li>Řádek záhlaví je zmrazený (zůstává viditelný při posouvání)</li>
                </ul>

                <div class="warning-box">
                    <strong>Pamatujte:</strong> Export vždy vylučuje neaktivní transakce. Pokud chcete zahrnout určité transakce do exportu, ujistěte se, že jsou označeny jako Aktivní (zaškrtávací políčko zaškrtnuto) na Přehledu.
                </div>
            </div>

        </div>
    </main>

    <script src="app.js"></script>
    <script>
        if (!requireAuth()) {
            throw new Error('Not authenticated');
        }
        setupNavbar();
    </script>
</body>
</html>
