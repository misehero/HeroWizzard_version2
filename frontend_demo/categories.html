<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pravidla kategorií - HeroWizzard</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .rule-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .rule-form .form-group { margin-bottom: 0; }
        .rule-form .full-width { grid-column: 1 / -1; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-overlay.hidden { display: none; }
        .modal { background: white; border-radius: 0.5rem; padding: 1.5rem;
            width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto;
            position: relative; z-index: 1001; }
        .modal-header { display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 1rem; }
        .modal-close { background: none; border: none; font-size: 1.5rem;
            cursor: pointer; color: var(--gray-500); padding: 0.5rem; }
        .actions { display: flex; gap: 0.5rem; }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="container">
            <h1 id="app-title">HeroWizzard</h1>
            <nav>
                <a href="dashboard.html">Přehled</a>
                <a href="upload.html">Import CSV</a>
                <a href="categories.html">Pravidla kategorií</a>
                <a href="help.html">Nápověda</a>
            </nav>
            <div class="user-info">
                <span id="user-info">Načítání...</span>
                <button class="logout-btn" id="logout-btn">Odhlásit</button>
            </div>
        </div>
    </header>

    <main class="container">
        <div id="alert-container"></div>

        <!-- Actions -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Pravidla automatické kategorizace</h2>
                <div class="actions">
                    <button class="btn btn-outline btn-sm" id="apply-rules-btn">
                        Použít pravidla na nezařazené
                    </button>
                    <button class="btn btn-primary btn-sm" id="add-rule-btn">
                        + Přidat pravidlo
                    </button>
                </div>
            </div>

            <p class="text-muted mb-2">
                Pravidla se aplikují v pořadí priority při importu transakcí.
                Hierarchie shody: 1. Číslo účtu, 2. Název obchodníka, 3. Klíčové slovo
            </p>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Název</th>
                            <th>Typ shody</th>
                            <th>Režim shody</th>
                            <th>Hodnota shody</th>
                            <th>Nastaví P/V</th>
                            <th>Nastaví kategorii</th>
                            <th>Priorita</th>
                            <th>Aktivní</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody id="rules-table">
                        <tr>
                            <td colspan="9" class="text-center text-muted">Načítání...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Rule Types Info -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Typy shody</h2>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Typ</th>
                            <th>Priorita</th>
                            <th>Porovnává s</th>
                            <th>Příklad</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Protiúčet</strong></td>
                            <td>1 (Nejvyšší)</td>
                            <td>Číslo protiúčtu</td>
                            <td>123456789/0100</td>
                        </tr>
                        <tr>
                            <td><strong>Obchodník</strong></td>
                            <td>2</td>
                            <td>Název obchodníka</td>
                            <td>ALBERT, LIDL, PENNY</td>
                        </tr>
                        <tr>
                            <td><strong>Klíčové slovo</strong></td>
                            <td>3 (Nejnižší)</td>
                            <td>Zpráva, poznámky, název protistrany</td>
                            <td>FAKTURA, MZDA, NÁJEM</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Add/Edit Rule Modal -->
    <div class="modal-overlay hidden" id="rule-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">Přidat pravidlo</h3>
                <button type="button" class="modal-close" id="modal-close">&times;</button>
            </div>

            <form id="rule-form">
                <input type="hidden" id="rule-id">

                <div class="rule-form">
                    <div class="form-group full-width">
                        <label for="rule-name">Název pravidla *</label>
                        <input type="text" id="rule-name" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="rule-match-type">Typ shody *</label>
                        <select id="rule-match-type" class="form-control" required>
                            <option value="protiucet">Protiúčet (Číslo účtu)</option>
                            <option value="merchant">Název obchodníka</option>
                            <option value="keyword">Klíčové slovo</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="rule-match-mode">Režim shody *</label>
                        <select id="rule-match-mode" class="form-control" required>
                            <option value="exact">Přesná shoda</option>
                            <option value="contains">Obsahuje</option>
                            <option value="regex">Regulární výraz</option>
                        </select>
                    </div>

                    <div class="form-group full-width">
                        <label for="rule-match-value">Hodnota shody *</label>
                        <input type="text" id="rule-match-value" class="form-control" required
                            placeholder="Číslo účtu, název obchodníka nebo klíčové slovo">
                    </div>

                    <div class="form-group">
                        <label for="rule-priority">Priorita</label>
                        <input type="number" id="rule-priority" class="form-control" value="100" min="1">
                    </div>

                    <div class="form-group">
                        <label for="rule-case-sensitive">
                            <input type="checkbox" id="rule-case-sensitive">
                            Rozlišovat velká/malá písmena
                        </label>
                    </div>

                    <hr class="full-width" style="border: none; border-top: 1px solid var(--gray-200); margin: 1rem 0;">

                    <div class="form-group">
                        <label for="rule-set-pv">Nastavit P/V</label>
                        <select id="rule-set-pv" class="form-control">
                            <option value="">-- Nenastavovat --</option>
                            <option value="P">Příjem (P)</option>
                            <option value="V">Výdaj (V)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="rule-set-vn">Nastavit V/N</label>
                        <select id="rule-set-vn" class="form-control">
                            <option value="">-- Nenastavovat --</option>
                            <option value="V">Výnosy</option>
                            <option value="N">Náklady</option>
                            <option value="-">—</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="rule-set-druh">Nastavit kategorii (Druh)</label>
                        <input type="text" id="rule-set-druh" class="form-control"
                            placeholder="např. fixní, variabilní, mzdy">
                    </div>

                    <div class="form-group">
                        <label for="rule-set-detail">Nastavit detail</label>
                        <input type="text" id="rule-set-detail" class="form-control"
                            placeholder="Popis detailu">
                    </div>

                    <div class="form-group">
                        <label for="rule-set-kmen">Nastavit KMEN</label>
                        <select id="rule-set-kmen" class="form-control">
                            <option value="">-- Nenastavovat --</option>
                            <option value="MH">MH</option>
                            <option value="SK">SK</option>
                            <option value="XP">XP</option>
                            <option value="FR">FR</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="rule-set-dane">
                            <input type="checkbox" id="rule-set-dane">
                            Nastavit Daně (daňově relevantní)
                        </label>
                    </div>

                    <div class="form-group full-width">
                        <label for="rule-description">Popis</label>
                        <textarea id="rule-description" class="form-control" rows="2"
                            placeholder="Volitelný popis, co toto pravidlo dělá"></textarea>
                    </div>
                </div>

                <div class="mt-2" style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" id="modal-cancel">Zrušit</button>
                    <button type="submit" class="btn btn-primary" id="modal-save">Uložit pravidlo</button>
                </div>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        if (!requireAuth()) {
            throw new Error('Not authenticated');
        }

        setupNavbar();

        // DOM elements
        const rulesTable = document.getElementById('rules-table');
        const alertContainer = document.getElementById('alert-container');
        const modal = document.getElementById('rule-modal');
        const modalTitle = document.getElementById('modal-title');
        const ruleForm = document.getElementById('rule-form');

        // Load rules
        async function loadRules() {
            try {
                const data = await api.getCategoryRules();
                const rules = data.results || data || [];

                if (rules.length === 0) {
                    rulesTable.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center text-muted">
                                Žádná pravidla nejsou definována. Klikněte na "Přidat pravidlo" pro vytvoření.
                            </td>
                        </tr>
                    `;
                    return;
                }

                rulesTable.innerHTML = rules.map(rule => `
                    <tr>
                        <td><strong>${utils.escapeHtml(rule.name)}</strong></td>
                        <td><span class="badge badge-info">${rule.match_type}</span></td>
                        <td>${rule.match_mode}</td>
                        <td><code>${utils.escapeHtml(rule.match_value?.substring(0, 30))}${rule.match_value?.length > 30 ? '...' : ''}</code></td>
                        <td>${rule.set_prijem_vydaj ? utils.getPVBadge(rule.set_prijem_vydaj) : '-'}</td>
                        <td>${utils.escapeHtml(rule.set_druh) || '-'}</td>
                        <td>${rule.priority}</td>
                        <td>${rule.is_active ?
                            '<span class="badge badge-success">Ano</span>' :
                            '<span class="badge badge-gray">Ne</span>'}</td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-outline btn-sm" onclick="editRule('${rule.id}')">Upravit</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteRule('${rule.id}')">Smazat</button>
                            </div>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Failed to load rules:', error);
                rulesTable.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-danger">
                            Nepodařilo se načíst pravidla. ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Modal functions
        function openModal(title = 'Přidat pravidlo') {
            modalTitle.textContent = title;
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
            ruleForm.reset();
            document.getElementById('rule-id').value = '';
        }

        document.getElementById('add-rule-btn').addEventListener('click', () => {
            openModal('Přidat pravidlo');
        });

        document.getElementById('modal-close').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeModal();
        });

        document.getElementById('modal-cancel').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeModal();
        });

        // Close modal when clicking overlay (but not the modal itself)
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        // Prevent modal content clicks from closing
        document.querySelector('.modal').addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Edit rule
        let rulesCache = [];
        async function editRule(id) {
            try {
                // Find rule in cache or fetch
                let rule = rulesCache.find(r => r.id === id);
                if (!rule) {
                    const data = await api.getCategoryRules();
                    rulesCache = data.results || data || [];
                    rule = rulesCache.find(r => r.id === id);
                }

                if (!rule) {
                    utils.showAlert(alertContainer, 'Pravidlo nenalezeno', 'danger');
                    return;
                }

                // Populate form
                document.getElementById('rule-id').value = rule.id;
                document.getElementById('rule-name').value = rule.name || '';
                document.getElementById('rule-match-type').value = rule.match_type || 'keyword';
                document.getElementById('rule-match-mode').value = rule.match_mode || 'contains';
                document.getElementById('rule-match-value').value = rule.match_value || '';
                document.getElementById('rule-priority').value = rule.priority || 100;
                document.getElementById('rule-case-sensitive').checked = rule.case_sensitive || false;
                document.getElementById('rule-set-pv').value = rule.set_prijem_vydaj || '';
                document.getElementById('rule-set-vn').value = rule.set_vlastni_nevlastni || '';
                document.getElementById('rule-set-druh').value = rule.set_druh || '';
                document.getElementById('rule-set-detail').value = rule.set_detail || '';
                document.getElementById('rule-set-kmen').value = rule.set_kmen || '';
                document.getElementById('rule-set-dane').checked = rule.set_dane || false;
                document.getElementById('rule-description').value = rule.description || '';

                openModal('Upravit pravidlo');
            } catch (error) {
                utils.showAlert(alertContainer, `Nepodařilo se načíst pravidlo: ${error.message}`, 'danger');
            }
        }

        // Delete rule
        async function deleteRule(id) {
            if (!confirm('Opravdu chcete smazat toto pravidlo?')) return;

            try {
                await api.deleteCategoryRule(id);
                utils.showAlert(alertContainer, 'Pravidlo úspěšně smazáno', 'success');
                loadRules();
            } catch (error) {
                utils.showAlert(alertContainer, `Nepodařilo se smazat pravidlo: ${error.message}`, 'danger');
            }
        }

        // Save rule
        ruleForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('rule-id').value;
            const data = {
                name: document.getElementById('rule-name').value,
                match_type: document.getElementById('rule-match-type').value,
                match_mode: document.getElementById('rule-match-mode').value,
                match_value: document.getElementById('rule-match-value').value,
                priority: parseInt(document.getElementById('rule-priority').value) || 100,
                case_sensitive: document.getElementById('rule-case-sensitive').checked,
                description: document.getElementById('rule-description').value
            };

            // Optional set fields
            const setPV = document.getElementById('rule-set-pv').value;
            if (setPV) data.set_prijem_vydaj = setPV;

            const setVN = document.getElementById('rule-set-vn').value;
            if (setVN) data.set_vlastni_nevlastni = setVN;

            const setDruh = document.getElementById('rule-set-druh').value;
            if (setDruh) data.set_druh = setDruh;

            const setDetail = document.getElementById('rule-set-detail').value;
            if (setDetail) data.set_detail = setDetail;

            const setKmen = document.getElementById('rule-set-kmen').value;
            if (setKmen) data.set_kmen = setKmen;

            if (document.getElementById('rule-set-dane').checked) {
                data.set_dane = true;
            }

            try {
                if (id) {
                    await api.updateCategoryRule(id, data);
                    utils.showAlert(alertContainer, 'Pravidlo úspěšně aktualizováno', 'success');
                } else {
                    await api.createCategoryRule(data);
                    utils.showAlert(alertContainer, 'Pravidlo úspěšně vytvořeno', 'success');
                }
                closeModal();
                loadRules();
            } catch (error) {
                utils.showAlert(alertContainer, `Nepodařilo se uložit pravidlo: ${error.message}`, 'danger');
            }
        });

        // Apply rules to uncategorized
        document.getElementById('apply-rules-btn').addEventListener('click', async () => {
            if (!confirm('Použít všechna aktivní pravidla na nezařazené transakce?')) return;

            try {
                utils.showLoading();
                const result = await api.applyRulesToUncategorized();
                utils.hideLoading();

                const count = result.categorized_count || result.updated || 0;
                utils.showAlert(alertContainer,
                    `Pravidla aplikována. ${count} transakcí kategorizováno.`,
                    'success'
                );
            } catch (error) {
                utils.hideLoading();
                utils.showAlert(alertContainer,
                    `Nepodařilo se aplikovat pravidla: ${error.message}`,
                    'danger'
                );
            }
        });

        // Initial load
        loadRules().then(() => {
            // Cache rules for editing
            api.getCategoryRules().then(data => {
                rulesCache = data.results || data || [];
            });
        });
    </script>
</body>
</html>
